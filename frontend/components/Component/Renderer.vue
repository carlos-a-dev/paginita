<template>
  <component
    :is="component"
    v-if="component && visible"
    v-bind="cprops"
    :data="$props.data"
  />
</template>

<script setup lang="ts">
import type { Component } from '~/types/strapi/strapi'

const rProps = withDefaults(
  defineProps<Component & {
    lazy?: boolean
    visible?: boolean
    props?: Record<string, unknown>
    data?: Record<string, unknown>
  }>(),
  {
    lazy: false,
    visible: true,
  },
)

const cprops = computed(() => {
  return Object.fromEntries(
    Object.entries(rProps.props ?? {} as object).filter(([key]) => !['id'].includes(key)),
  )
})

const component = computed(() => {
  const key = rProps.__component

  if (!key || !key.startsWith('f.')) return null

  // Convert "f.section-title" to "SectionTitle"
  const componentName = (rProps.lazy ? 'Lazy' : '') + key
    .replace('.', '-')
    .split('-')
    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
    .join('')

  // Eager fallback for already-loaded/auto-imported component
  try {
    const component = resolveComponent(componentName)
    console.debug(`[DynamicComponent] Loaded component: ${componentName}`)
    return typeof component === 'string' ? null : componentName
  }
  catch (err) {
    console.warn(`[DynamicComponent] Component not found: ${componentName}`)
    console.warn(err)
    return null
  }
})
</script>
